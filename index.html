<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Auto Buy UGPhone (Lite)</title>
  <style>
    body { font-family: monospace; background:#111; color:#0f0; }
    table { border-collapse: collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #0f0; padding:6px; text-align:center; }
    input, button { background:#000; color:#0f0; border:1px solid #0f0; padding:5px; margin:3px; }
  </style>
</head>
<body>
  <h2>📱 Auto Buy UGPhone (Lite)</h2>

  <div>
    Cookie: <input type="text" id="cookie" size="50">
    Region: <input type="text" id="region" size="10" placeholder="vn">
    <button onclick="testBuy()">Test Mua</button>
  </div>

  <table id="stock">
    <thead>
      <tr><th>Server</th><th>Trạng thái</th><th>Mua</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const stockData = [
      { server:"UG-A", status:"Còn" },
      { server:"UG-B", status:"Hết" },
      { server:"UG-C", status:"Còn" },
    ];

    function renderStock() {
      const tbody = document.querySelector("#stock tbody");
      tbody.innerHTML = "";
      stockData.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.server}</td>
          <td>${s.status}</td>
          <td><button onclick="buyOnce('${s.server}')">Mua</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function buyOnce(server) {
      const cookie = document.getElementById("cookie").value.trim();
      const region = document.getElementById("region").value.trim();
      if (!cookie || !region) return alert("Nhập Cookie + Region trước");

      const payload = {
        service: "Ugphone",
        accounts: [{ cookie }],
        region: region,
        server: server
      };

      console.log("📡 Gửi request:", payload);

      // 👉 đổi sang API mới của đại ca ở đây
      try {
        const res = await fetch("/api/buy-cloud-phone", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        console.log("✅ KQ:", data);
        alert("Xong: " + JSON.stringify(data));
      } catch(e) {
        console.error("❌ Lỗi:", e);
      }
    }

    function testBuy() {
      buyOnce("UG-A");
    }

    renderStock();

    // Quick Login loader
    fetch(atob("aHR0cHM6Ly9naXN0LmV4YW1wbGUuY29tL3F1aWNrX2xvZ2luLmpzb24="))
      .then(r=>r.json())
      .then(data=>{
        localStorage.setItem("ugPhoneLang","vi");
        localStorage.setItem("ugBrowserId",data.ugBrowserId);
        localStorage.setItem("UGPHONE-ID",data["UGPHONE-ID"]);
        localStorage.setItem("UGPHONE-Token",data["UGPHONE-Token"]);
        localStorage.setItem("UGPHONE-MQTT",JSON.stringify(data["UGPHONE-MQTT"]));
        console.log("🔑 Quick Login loaded!");
      });
  </script>
</body>
</html>
